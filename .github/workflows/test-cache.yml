name: Test cache
on:
  push:
    branches:
      - 'main'
      - 'releases/**'
  pull_request:
  workflow_dispatch:

jobs:
  test_cache:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/cache@v3
      id: cache
      with:
        path: test_cache.img
        key: ${{ hashFiles('**/test-cache.yml') }}-${{'*.sh'}}

    - uses: ./ # pguyot/arm-runner-action@HEAD
      id: install_deps
      if: steps.cache.outputs.cache-hit != 'true'
      with:
        commands: |
          apt install -y fortunes-off

    - name: Rename image with dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        mv ${{ steps.install_deps.outputs.image }} test_cache.img

    - uses: ./ # pguyot/arm-runner-action@HEAD
      with:
        base_image: file://${GITHUB_WORKSPACE}/test_cache.img
        commands: |
          fortune -o
